StockQ — Launch-Ready MVP Spec (Backend + OAuth + RN App + Ops)

기준일: 2025-09-18 (KST, Asia/Seoul)
목표: 관심종목 기반 미국 주식 뉴스 수집→요약→피드 제공. RN 앱으로 로그인/즐겨찾기/리포트 열람.
원칙: 기능 먼저 → 계측 → 단계적 최적화. P95≤200ms(피드) 최종 목표.

0) Scope / Non-Goals

Scope

백엔드 REST API (DRF) + Celery/Beat(수집·요약 배치)

OAuth(구글/애플/카카오) + 이메일/비번

RN 앱(로그인, 관심종목 CRUD, 오늘 리포트, 상세 보기, 설정)

푸시 알림(“오늘 리포트 도착”)

스키마/헬스체크/관측성/CI·CD/스토어 준비

Non-Goals

자동매매, 실시간 체결 스트림, 고급 차트, 다국가 확장

1) 데이터 모델 (최소)

User(커스텀 또는 기본)

Stock(symbol UNIQUE, name, exchange, currency)

FavoriteStock(user, stock) UNIQUE(user,stock)

News(stock, headline, url, source, published_at, external_id UNIQUE, raw_json JSONB)

Summary(user, date, stock NULLABLE, text, method ENUM[rule,llm]) UNIQUE(user,date,stock NULLS DISTINCT)

Price(stock, ts, o,h,l,c,v) UNIQUE(stock, ts)

인덱스: (stock_id,published_at DESC), (stock_id,ts DESC), external_id UNIQUE

[BLOCKER] external_id 유니크 없으면 중복 폭증 → 필수.

2) API 명세 (최소·확정)
Auth

POST /api/auth/signup → {email,password,nickname?} → 201 {id,email}

POST /api/auth/login → {email,password} → 200 {access,refresh}

POST /api/auth/refresh → {refresh} → 200 {access}

POST /api/auth/logout → {refresh} → 204 ← JWT Blacklist 필수 [BLOCKER]

DELETE /api/users/me → 204 (하드딜리트 금지: soft delete or status)

OAuth

POST /api/auth/oauth/<provider> (google|apple|kakao)

Body: {id_token or authorization_code} (카카오는 access_token)

서버: 토큰 검증→이메일/서브ID 매칭→최초 가입시 계정 생성→JWT 발급

응답: 200 {access,refresh, is_new:false} 또는 201 {… , is_new:true}

GET /api/auth/providers → {google:enabled, apple:enabled, kakao:enabled}

Stocks & Favorites

GET /api/stocks?q&limit<=50 → 검색

GET /api/favorites → 유저 즐겨찾기 목록

POST /api/favorites → {symbol} → 201 / 409(중복) / 400(미존재)

DELETE /api/favorites/{symbol} → 204

News & Summary

POST /api/ingest → {symbols?:[...], since?:YYYY-MM-DD} → 202 {task_id} (비동기 수집)

GET /api/news?symbol?&since?&page&limit<=50 → 최신순 피드(기본: 즐겨찾기)

POST /api/summaries → {date, symbol?} → 202 {task_id} (기본: 규칙요약, 플래그로 LLM)

GET /api/summaries?date&symbol? → {summary, method, updated_at} or 404

GET /api/tasks/{task_id} → {state, progress, result?}

Prices

GET /api/stocks/{symbol}/prices?start&end&interval=1m|5m|1d&limit<=3000

(서버 내부) fetch_prices 배치 upsert

System / Docs / Readiness

GET /api/health/ → 200 (간단)

GET /api/readiness/ → DB/Redis/External API 체크(타임아웃 300~800ms) ← [BLOCKER]

GET /api/schema/ + Swagger UI/Redoc ← [BLOCKER] (스토어 심사/QA에 필요)

공통 정책

권한: 기본 IsAuthenticated, /health·OAuth 공용 일부 AllowAny

스로틀: Anon 30/min, User 120/min (로그인/가입은 더 보수)

응답/에러 포맷:

{"error":{"code":"duplicate","message":"favorite already exists","detail":{"symbol":"AAPL"}}}

3) 비동기/Celery & 스케줄

태스크

fetch_news(symbols:list, window_days:int) → Finnhub company-news 호출, external_id 기반 upsert, 429/5xx 백오프 재시도

fetch_prices(symbol, start,end,interval) → bulk upsert

generate_summary(user_id, date, symbol?) → rule 기본 / llm 플래그 시 OpenAI 호출

Beat 스케줄

매일 06:00 KST: 즐겨찾기 전종목 fetch_news (rate-limit 배치 쪼개기)

06:30 KST: 요약 태스크 fan-out (generate_summary per symbol)

레이트 리밋 전략

Finnhub Free: 60 req/min 가정 → batch=50, await sleep(60) 후 잔여

429시 지수백오프: 2s→4s→8s(최대 64s), max_retries=5

모니터링: Flower(선택) 또는 자체 /api/tasks/{id} 폴링

[BLOCKER] Beat 스케줄링 없으면 “아침 자동 수집/요약” 불가.

4) OAuth 설계 (Google / Apple / Kakao)

Google: ID Token 검증(JWK, aud/client_id 매칭, email_verified), 서브ID 저장

Apple: ID Token(Sign in with Apple, nonce 사용 권장), 서버에서 JWK 검증

Kakao: Access Token → GET /v2/user/me로 사용자 식별자, 이메일(동의 여부 주의)

공통

최초 로그인: 이메일/서브ID로 User 생성(이메일 없으면 provider:sub 기반 계정 + 추가 수집 플로우)

같은 이메일로 다른 provider 연동 시 링크(중복 계정 방지)

클라이언트: RN에서 provider SDK 통해 토큰 획득 → 서버 엔드포인트에 전달

보안 필수:

서버에서만 클라이언트 비밀키 사용(코드 교환 방식 권장)

iOS 애플: team_id, key_id, private_key 보관(서버 비밀)

리플레이 방지: nonce/state 처리

5) React Native 앱 (Expo 권장)
화면/네비게이션

Auth Stack

로그인(이메일/비번 + OAuth 버튼 3종) [BLOCKER]

회원가입

Main Tabs

리포트: 오늘 요약 카드 리스트(즐겨찾기 기준) [BLOCKER]

즐겨찾기: 종목 검색/추가/삭제

설정: 알림 on/off, 로그아웃, 약관/개인정보

상세 화면

종목별 기사 리스트/원문 열기(WebView or 외부 브라우저)

상태/스토리지/네트워킹

상태: Zustand(auth 토큰/유저/즐겨찾기/리포트 캐시)

보안 저장: expo-secure-store(access/refresh) [BLOCKER]

토큰 로테이션: 요청 401 시 refresh→재시도(1회)→실패 시 강제 로그아웃

네트워크: axios 인스턴스, baseURL/env 분리, 공통 에러 핸들러

로딩 UX: 스켈레톤/리프레시/오프라인 알림

OAuth (클라)

Expo AuthSession 또는 각 SDK 사용

Google: expo-auth-session/providers/google

Apple: expo-apple-authentication(iOS)

Kakao: @react-native-seoul/kakao-login 또는 AuthSession로 커스텀

푸시

Expo Notifications or FCM 직접

백엔드: “06:40 KST 리포트 준비됨” 토픽/유저별 푸시 [BLOCKER]

설정: RN에서 토큰 수집→서버 저장→Opt-in/Opt-out

품질

다크모드, 한국어 기본, 접근성(폰트 스케일)

크래시/로그: Sentry(DSN 분리)

6) 보안/컴플라이언스

JWT: Access=15m, Refresh=14d, 로그아웃=Blacklist [BLOCKER]

CORS: dev *, prod 화이트리스트

입력 검증: symbol 화이트리스트(DB 존재)

헤더 보안: SECURE_*, X-Content-Type-Options, Referrer-Policy

비밀키: .env(로컬) / GitHub Actions secrets / prod는 Secret Manager

개인정보: Privacy Policy/ToS 링크(앱 내 노출) [BLOCKER for 심사]

로깅: PII 최소화, 이메일 마스킹

7) 관측성/운영

헬스: /api/health, /api/readiness(DB/Redis/Ext API)

메트릭: Prometheus식 지표 혹은 StatsD

HTTP latency(histogram: P50/P95/P99), 에러율, QPS

Celery: queue length, task failures, runtime

구조화 로그(JSON): ts, level, user_id, path, status, latency_ms, trace_id

에러 추적: Sentry(백엔드/앱)

알람: 에러율/P95 임계치, 큐 적체

8) 성능 목표 & 절차

베이스라인: 캐시/인덱스 없이 측정(Locust 50 RPS 5분)

1차: 인덱스/쿼리/Serializer 정리 → 피드 P95 -30%

2차: 캐시(유저별 페이지 TTL60s) + ETag → 캐시힛 P95 100~180ms

3차: Gunicorn/uvicorn 워커/keep-alive/DB pool 튜닝

인제스트: bulk upsert, 재시도 백오프, 동시성 조절

9) CI/CD & 배포

GitHub Actions

test + lint + build + docker push

.env.example 제공, prod 시크릿은 GitHub Secrets

도커

멀티스테이지 Dockerfile, compose.prod.yml

마이그레이션 훅

배포 후 체크: /api/health, /api/readiness, 스모크 테스트

10) 스토어 준비 (출시 필수)

앱 내 개인정보 처리방침/이용약관 링크(웹 문서) [BLOCKER]

OAuth 권한 설명(애플 심사 메모), Sign in with Apple 의무(iOS) [BLOCKER]

스크린샷, 아이콘, 앱 설명(과장·투자권유 표현 금지)

푸시 권한 사유(localized), 트래킹(광고) 사용 시 ATT 대처

11) ENV (요약)

Backend: DJANGO_SECRET_KEY, DATABASE_URL, REDIS_URL, FINNHUB_API_KEY, OPENAI_API_KEY(선택), SUMMARY_USE_LLM=false, ALLOWED_HOSTS, TIME_ZONE=Asia/Seoul

OAuth: GOOGLE_CLIENT_ID/SECRET, APPLE_TEAM_ID/KEY_ID/PRIVATE_KEY, KAKAO_REST_KEY

RN(Expo): EAS_PROJECT_ID, EXPO_PUBLIC_API_BASE_URL, EXPO_PUBLIC_GOOGLE_CLIENT_ID, …

12) 체크리스트 (BLOCKER 우선)
Backend

 /api/auth/logout (JWT Blacklist) [BLOCKER]

 /api/readiness DB/Redis/Ext API 체크 [BLOCKER]

 /api/schema + Swagger UI/Redoc [BLOCKER]

 external_id UNIQUE 마이그레이션 [BLOCKER]

 Beat 스케줄(06:00/06:30) [BLOCKER]

 Finnhub 레이트리밋 안전 배치(60/min) [BLOCKER]

 fetch_prices + 가격 API

 generate_summary(rule) + 결과 조회

 /api/ingest 태스크화 + /api/tasks/{id} 상태조회

 캐시/인덱스/쿼리 1차 튜닝(기능 후)

OAuth

 Google/Apple/Kakao 서버 검증 엔드포인트 [BLOCKER]

 iOS Sign in with Apple 적용(심사 의무) [BLOCKER]

 이메일 없는 OAuth 계정 플로우(추가정보 수집)

RN App

 로그인 화면(OAuth 3종 + 이메일) [BLOCKER]

 토큰 보관 SecureStore [BLOCKER]

 즐겨찾기 CRUD

 오늘 리포트(요약 카드) [BLOCKER]

 상세 기사 보기(WebView/외부 브라우저)

 설정(알림, 로그아웃, 약관/개인정보 링크) [BLOCKER]

 푸시 알림(리포트 준비) [BLOCKER]

Ops

 Sentry 연동(백엔드/RN)

 Locust 베이스라인/최적화 후 리포트

 GitHub Actions → 빌드/테스트/이미지 푸시

 배포 후 스모크 테스트 스크립트

 Privacy/ToS 문서 배포 [BLOCKER]

13) 요청/응답 예시 (간단)

로그아웃

POST /api/auth/logout
{ "refresh": "..." }  → 204


OAuth(구글)

POST /api/auth/oauth/google
{ "id_token": "..." } → 200 {access,refresh,is_new:false}


리포트(오늘)

GET /api/summaries?date=2025-09-17
→ { items:[{symbol:"AAPL", summary:"...", method:"rule"}], updated_at:"..." }


뉴스 피드

GET /api/news?limit=20
→ { items:[{symbol, headline, published_at, source, url}], next:"cursor" }

14) 리스크 & 완화

Finnhub 레이트리밋/429 → 배치 모듈화 + 지수백오프 + 모니터링

OAuth 토큰 검증 실패/시간차 → 서버 검증 의무화, 클럭 스큐 허용

심사 리젝(애플) → Sign in with Apple, 개인정보 페이지, 기능 설명 보강

비용(LLM) → rule 기본, SUMMARY_USE_LLM=false로 출시, 추후 유료 플랜에 LLM

15) 최종 컷오버 체크

 06:00 수집, 06:30 요약 스케줄 실제 동작 캡처

 푸시 도착→앱 진입→요약 리스트 노출 영상

 /api/schema//health//readiness 스샷

 베이스라인 vs 최적화 성능 그래프
“CI 안정성 강화 (DB healthcheck + env_file 일관성)”
 스토어 메타(아이콘/스크린샷/설명/정책 링크) 완비

이 파일을 docs/LAUNCH_MVP_SPEC.md로 커밋해. 위 [BLOCKER] 항목부터 처리하지 않으면 출시가 안 된다. 다음 작업 순서는 아래처럼 가져가라:

/api/auth/logout + JWT Blacklist → 2) /api/readiness → 3) /api/schema

Beat 스케줄 + 수집/요약 태스크 → 5) RN 로그인/OAuth/리포트/푸시

Privacy/ToS 페이지 배포 → 7) 베이스라인 측정 → 8) 1차 최적화

질문 없이 바로 실행 가능한 수준으로 쪼갰다. 진행하면서 막히는 지점 나오면, 근거 → 영향 → 고치는 법 순으로 내가 다시 태클한다.